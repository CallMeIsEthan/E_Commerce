@model E_Commerce.Web.ViewModels.LoginViewModel
@{
    ViewBag.Title = "Đăng nhập";
}

<!-- Page Title -->
<div class="page-title light-background">
    <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">Đăng nhập</h1>
        <nav class="breadcrumbs">
            <ol>
                <li>
                    <a href="@Url.Action("Index","Home", new { area="User" })">Trang chủ</a>
                </li>
                <li class="current">Đăng nhập</li>
            </ol>
        </nav>
    </div>
</div>

<section id="login" class="login section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="auth-container" data-aos="fade-in" data-aos-delay="200">
                    <div class="auth-form login-form active">
                        <div class="form-header">
                            <h3>Chào mừng trở lại</h3>
                            <p>Đăng nhập tài khoản của bạn</p>
                        </div>

                        <!-- AJAX Login Form -->
                        @using (Html.BeginForm(null, null, FormMethod.Post,
                            new
                            {
                                id = "loginForm",
                                action = Url.Action("Login", "Account", new { area = "User" }),
                                @class = "auth-form-content"
                            }))
                        {
                            @Html.AntiForgeryToken()
                            <div class="input-group mb-3">
                                <span class="input-icon"><i class="bi bi-envelope"></i></span>
                                <input type="email" name="Username" class="form-control"
                                       placeholder="Email" autocomplete="email" />
                            </div>

                            <div class="input-group mb-3">
                                <span class="input-icon"><i class="bi bi-lock"></i></span>
                                <input id="Password" type="password" name="Password" class="form-control"
                                       placeholder="Password" autocomplete="current-password" />
                                <span class="password-toggle" style="cursor:pointer;">
                                    <i class="bi bi-eye" id="toggleEye"></i>
                                </span>
                            </div>

                            <div class="form-options mb-4">
                                <div class="remember-me">
                                    <input type="checkbox" name="isCheckbox" id="rememberLogin">
                                    <label for="rememberLogin">Nhớ mật khẩu</label>
                                </div>
                                <input type="hidden" name="returnUrl" value="@ViewBag.ReturnUrl" />
                                <a href="#" class="forgot-password">Quên mật khẩu?</a>
                            </div>

                            <button type="submit" class="auth-btn primary-btn mb-3">
                                Đăng nhập
                                <i class="bi bi-arrow-right"></i>
                            </button>
                            <!-- ⚠ Giữ lại nhưng không hiển thị thông báo manual -->
                            <div id="loginMessage" style="margin-top:10px; display:none;"></div>
                            <div class="divider"><span>or</span></div>

                            <button type="button" class="auth-btn social-btn">
                                <i class="bi bi-google"></i>
                                Tiếp tục với Google
                            </button>

                            <div class="switch-form">
                                <span>Bạn chưa có tài khoản?</span>
                                <a href="@Url.Action("Register","Account", new { area="User" })"
                                   class="switch-btn" data-target="register">Tạo tài khoản</a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center">
        <i class="bi bi-arrow-up-short"></i>
    </a>
</section>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
    <script>
        $(function () {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                positionClass: "toast-top-right",
                timeOut: "3000"
            };

            // Password toggle
            $('#toggleEye').on('click', function () {
                const passwordInput = $('#Password');
                const icon = $(this);

                if (passwordInput.attr('type') === 'password') {
                    passwordInput.attr('type', 'text');
                    icon.removeClass('bi-eye').addClass('bi-eye-slash');
                } else {
                    passwordInput.attr('type', 'password');
                    icon.removeClass('bi-eye-slash').addClass('bi-eye');
                }
            });

            // Handle form submit
            $("#loginForm").submit(function (e) {
                e.preventDefault();

                var $form = $(this);
                var $btn = $form.find('button[type="submit"]');

                // Validate form - lấy errors và hiển thị trong toast
                var validator = $form.validate();
                if (!validator.form()) {
                    var errors = [];
                    
                    // Lấy errors từ validator
                    $.each(validator.errorList, function (index, error) {
                        if (error.message && errors.indexOf(error.message) === -1) {
                            errors.push(error.message);
                        }
                    });
                    
                    // Lấy errors từ validation messages trên form
                    $form.find('.field-validation-error').each(function () {
                        var errorText = $(this).text().trim();
                        if (errorText && errors.indexOf(errorText) === -1) {
                            errors.push(errorText);
                        }
                    });
                    
                    if (errors.length > 0) {
                        toastr.error(errors.join('<br>'));
                    } else {
                        toastr.error("Vui lòng kiểm tra lại thông tin đã nhập!");
                    }
                    return false;
                }

                // Disable button and show loading
                var originalText = $btn.html();
                $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');

                $.ajax({
                    url: $form.attr("action"),
                    type: "POST",
                    data: $form.serialize(),
                    dataType: "json",
                    success: function (resp) {
                        if (resp.success) {
                            toastr.success(resp.message || "Đăng nhập thành công!");
                            setTimeout(function () {
                                window.location.href = resp.redirectUrl || '@Url.Action("Index", "Home", new { area = "User" })';
                            }, 1000);
                        } else {
                            toastr.error(resp.message || "Đăng nhập thất bại!");
                            $btn.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function (xhr) {
                        var errorMessage = "Không kết nối được máy chủ!";
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        toastr.error(errorMessage, "Lỗi kết nối");
                        $btn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });
    </script>
}

