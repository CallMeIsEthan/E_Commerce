@{
    ViewBag.Title = "Đổi mật khẩu";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="bi bi-key me-2"></i>Đổi mật khẩu
                    </h4>
                </div>
                <div class="card-body">
                    <form id="changePasswordForm">
                        @Html.AntiForgeryToken()

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="oldPassword" class="form-label">Mật khẩu hiện tại <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="oldPassword" name="oldPassword" required>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6">
                                    <small class="form-text text-muted">Mật khẩu phải có ít nhất 6 ký tự</small>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                                    <div class="invalid-feedback"></div>
                                </div>

                                <div class="mb-3">
                                    <button type="submit" class="btn btn-primary" id="btnChangePassword">
                                        <i class="bi bi-check-circle me-2"></i>Đổi mật khẩu
                                    </button>
                                    <a href="@Url.Action("Index", "Dashboard", new { area = "Admin" })" class="btn btn-secondary">
                                        <i class="bi bi-x-circle me-2"></i>Hủy
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            var isSubmitting = false;
            var $form = $('#changePasswordForm');
            var $btn = $('#btnChangePassword');
            var originalText = $btn.html();

            // Validate form
            $form.on('submit', function (e) {
                e.preventDefault();

                if (isSubmitting) {
                    return false;
                }

                // Clear previous errors
                $form.find('.is-invalid').removeClass('is-invalid');
                $form.find('.invalid-feedback').text('');

                // Get form values
                var oldPassword = $('#oldPassword').val();
                var newPassword = $('#newPassword').val();
                var confirmPassword = $('#confirmPassword').val();

                // Client-side validation
                var hasError = false;

                if (!oldPassword || oldPassword.trim() === '') {
                    $('#oldPassword').addClass('is-invalid');
                    $('#oldPassword').next('.invalid-feedback').text('Vui lòng nhập mật khẩu cũ');
                    hasError = true;
                }

                if (!newPassword || newPassword.trim() === '') {
                    $('#newPassword').addClass('is-invalid');
                    $('#newPassword').next('.invalid-feedback').text('Vui lòng nhập mật khẩu mới');
                    hasError = true;
                } else if (newPassword.length < 6) {
                    $('#newPassword').addClass('is-invalid');
                    $('#newPassword').next('.invalid-feedback').text('Mật khẩu phải có ít nhất 6 ký tự');
                    hasError = true;
                }

                if (!confirmPassword || confirmPassword.trim() === '') {
                    $('#confirmPassword').addClass('is-invalid');
                    $('#confirmPassword').next('.invalid-feedback').text('Vui lòng xác nhận mật khẩu mới');
                    hasError = true;
                } else if (newPassword !== confirmPassword) {
                    $('#confirmPassword').addClass('is-invalid');
                    $('#confirmPassword').next('.invalid-feedback').text('Mật khẩu xác nhận không khớp');
                    hasError = true;
                }

                if (hasError) {
                    return false;
                }

                // Disable button and show loading
                isSubmitting = true;
                $btn.prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang xử lý...');

                // Submit via AJAX
                $.ajax({
                    url: '@Url.Action("ChangePassword", "Account", new { area = "Admin" })',
                    type: 'POST',
                    data: {
                        oldPassword: oldPassword,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            toastr.success(response.message || 'Đổi mật khẩu thành công!');
                            // Reset form
                            $form[0].reset();
                            // Redirect after 1.5 seconds
                            setTimeout(function () {
                                window.location.href = '@Url.Action("Index", "Dashboard", new { area = "Admin" })';
                            }, 1500);
                        } else {
                            toastr.error(response.message || 'Đổi mật khẩu thất bại');
                            isSubmitting = false;
                            $btn.prop('disabled', false).html(originalText);
                        }
                    },
                    error: function (xhr, status, error) {
                        var errorMessage = 'Có lỗi xảy ra khi đổi mật khẩu';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        toastr.error(errorMessage);
                        isSubmitting = false;
                        $btn.prop('disabled', false).html(originalText);
                    }
                });

                return false;
            });
        });
    </script>
}

