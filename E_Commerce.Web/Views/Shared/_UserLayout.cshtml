<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>@(ViewBag.Title ?? "Trang ch·ªß") - NovaStore</title>
    <meta name="description" content="@(ViewBag.Description ?? "NovaStore - C·ª≠a h√†ng qu·∫ßn √°o th·ªùi trang uy t√≠n")">
    <meta name="keywords" content="@(ViewBag.Keywords ?? "qu·∫ßn √°o, th·ªùi trang, fashion")">

    <!-- Favicons -->
    <link href="https://res.cloudinary.com/dyvkrlz5i/image/upload/v1765680853/u6fkwhf7l2grvijqgn9l.jpg" rel="icon" type="image/jpeg">
    <link href="https://res.cloudinary.com/dyvkrlz5i/image/upload/v1765680853/u6fkwhf7l2grvijqgn9l.jpg" rel="apple-touch-icon">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600&subset=vietnamese&display=swap" rel="stylesheet">

    <link href="~/Content/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="~/Content/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />
    <link href="~/Content/vendor/aos/aos.css" rel="stylesheet" />
    <link href="~/Content/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />

    <link href="~/Content/css/main.css" rel="stylesheet">
    <style>
        html {
            zoom: 0.9;
        }
        /* Search suggestions dropdown */
        .search-form {
            position: relative;
        }
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            z-index: 1200;
            max-height: 340px;
            overflow-y: auto;
            padding: 6px;
        }
        .search-suggestions ul {
            margin: 0;
            padding: 0;
        }
        .search-suggestions .suggest-item {
            padding: 6px 8px;
            border-radius: 8px;
            transition: background-color 0.15s ease;
        }
        .search-suggestions .suggest-item:hover {
            background: #f7f7f7;
        }
        .search-suggestions .suggest-item a {
            display: flex;
            align-items: center;
            gap: 10px;
            color: inherit;
            text-decoration: none;
        }
        .search-suggestions .suggest-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            overflow: hidden;
            background: #f1f1f1;
            flex: 0 0 48px;
        }
        .search-suggestions .suggest-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .search-suggestions .suggest-info {
            flex: 1;
            min-width: 0;
        }
        .search-suggestions .suggest-name {
            font-weight: 600;
            font-size: 14px;
            color: #111;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .search-suggestions .suggest-price {
            font-size: 13px;
            color: #0d6efd;
            font-weight: 600;
        }
    </style>

    @RenderSection("styles", required: false)
</head>

<body class="index-page">

    <header id="header" class="header sticky-top">
        <!-- Top Bar -->
        <div class="top-bar py-2">
            <div class="container-fluid container-xl">
                <div class="row align-items-center">
                    <div class="col-lg-4 d-none d-lg-flex">
                        <div class="top-bar-item">
                            <i class="bi bi-telephone-fill me-2"></i>
                            <span>C·∫ßn h·ªó tr·ª£? G·ªçi ngay: </span>
                            <a href="tel:+84123456789">+84 (123) 456-789</a>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-12 text-center">
                        <div class="announcement-slider swiper init-swiper">
                            <script type="application/json" class="swiper-config">
                                {
                                  "loop": true,
                                  "speed": 600,
                                  "autoplay": {
                                    "delay": 5000
                                  },
                                  "slidesPerView": 1,
                                  "direction": "vertical",
                                  "effect": "slide"
                                }
                            </script>
                            <div class="swiper-wrapper">
                                <div class="swiper-slide">üöö Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n h√†ng tr√™n 1.000.000ƒë</div>
                                <div class="swiper-slide">üí∞ B·∫£o h√†nh 30 ng√†y ƒë·ªïi tr·∫£</div>
                                <div class="swiper-slide">üéÅ Gi·∫£m 20% cho ƒë∆°n h√†ng ƒë·∫ßu ti√™n</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4 d-none d-lg-block">
                        <div class="d-flex justify-content-end">
                            <div class="top-bar-item dropdown me-3">
                                <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-translate me-2"></i>VN
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-check2 me-2 selected-icon"></i>Ti·∫øng Vi·ªát</a></li>
                                    <li><a class="dropdown-item" href="#">English</a></li>
                                </ul>
                            </div>
                            <div class="top-bar-item dropdown">
                                <a href="#" class="dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="bi bi-currency-dollar me-2"></i>VND
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-check2 me-2 selected-icon"></i>VND</a></li>
                                    <li><a class="dropdown-item" href="#">USD</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Header -->
        <div class="main-header">
            <div class="container-fluid container-xl">
                <div class="d-flex py-3 align-items-center justify-content-between">

                    <!-- Logo -->
                    <a href="@Url.Action("Index", "Home", new { area = "User" })" class="logo d-flex align-items-center">
                        @*<img src="~/Content/img/logo.webp" alt="NovaStore" class="me-2">*@
                        <h1 class="sitename">NovaStore</h1>
                    </a>

                    <!-- Search -->
                    <form class="search-form desktop-search-form" action="@Url.Action("Index", "Product", new { area = "User" })" method="get">
                        <div class="input-group">
                            <input type="text" name="searchTerm" class="form-control" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." value="@Request.QueryString["searchTerm"]">
                            <button class="btn" type="submit">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div class="search-suggestions d-none" id="searchSuggestions"></div>
                    </form>

                    <!-- Actions -->
                    <div class="header-actions d-flex align-items-center justify-content-end">

                        <!-- Mobile Search Toggle -->
                        <button class="header-action-btn mobile-search-toggle d-xl-none" type="button" data-bs-toggle="collapse" data-bs-target="#mobileSearch" aria-expanded="false" aria-controls="mobileSearch">
                            <i class="bi bi-search"></i>
                        </button>

                        <!-- Account -->
                        @{
                            var isLogged = Session["UserId"] != null;
                            var userName = Session["Name"] as string ?? "T√†i kho·∫£n";
                        }
                        <div class="dropdown account-dropdown">
                            <button class="header-action-btn" data-bs-toggle="dropdown">
                                <i class="bi bi-person"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-header">
                                    <h6>@(isLogged ? (string.IsNullOrWhiteSpace(userName) ? "T√†i kho·∫£n" : userName) : "Ch√†o m·ª´ng ƒë·∫øn v·ªõi NovaStore")</h6>
                                    <p class="mb-0">
                                        @if (isLogged)
                                        {
                                            <span class="text-muted small">@Session["UserEmail"]</span>
                                        }
                                        else
                                        {
                                            @:Truy c·∫≠p t√†i kho·∫£n &amp; qu·∫£n l√Ω ƒë∆°n h√†ng
                                        }
                                    </p>
                                </div>
                                <div class="dropdown-body">
                                    @if (isLogged)
                                    {
                                        <a class="dropdown-item d-flex align-items-center" href="@Url.Action("Profile", "Account", new { area = "User" })">
                                            <i class="bi bi-person-circle me-2"></i>
                                            <span>Th√¥ng tin c√° nh√¢n</span>
                                        </a>
                                        <a class="dropdown-item d-flex align-items-center" href="@Url.Action("MyOrders", "Order", new { area = "User" })">
                                            <i class="bi bi-bag-check me-2"></i>
                                            <span>ƒê∆°n h√†ng c·ªßa t√¥i</span>
                                        </a>
                                        <a class="dropdown-item d-flex align-items-center" href="@Url.Action("Index", "Wishlist", new { area = "User" })">
                                            <i class="bi bi-heart me-2"></i>
                                            <span>Y√™u th√≠ch</span>
                                            <span class="badge bg-danger ms-auto" id="wishlist-count-dropdown">0</span>
                                        </a>
                                        <div class="dropdown-item d-flex align-items-center text-muted" style="cursor: not-allowed;">
                                            <i class="bi bi-gear me-2"></i>
                                            <span>C√†i ƒë·∫∑t (s·∫Øp ra m·∫Øt)</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <a class="dropdown-item d-flex align-items-center" href="@Url.Action("Login", "Account", new { area = "User" })">
                                            <i class="bi bi-person-circle me-2"></i>
                                            <span>ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω t√†i kho·∫£n</span>
                                        </a>
                                    }
                                </div>
                                <div class="dropdown-footer">
                                    @if (!isLogged)
                                    {
                                        <a href="@Url.Action("Login", "Account", new { area = "User" })" class="btn btn-primary w-100 mb-2">ƒêƒÉng nh·∫≠p</a>
                                        <a href="@Url.Action("Register", "Account", new { area = "User" })" class="btn btn-outline-primary w-100">ƒêƒÉng k√Ω</a>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action("Logout", "Account", new { area = "User" })" class="btn btn-outline-primary w-100">ƒêƒÉng xu·∫•t</a>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Wishlist -->
                        <a href="@Url.Action("Index", "Wishlist", new { area = "User" })" class="header-action-btn d-none d-md-block">
                            <i class="bi bi-heart"></i>
                            <span class="badge" id="wishlist-count">0</span>
                        </a>

                        <!-- Cart -->
                        <a href="@Url.Action("Index", "Cart", new { area = "User" })" class="header-action-btn">
                            <i class="bi bi-cart3"></i>
                            <span class="badge" id="cart-count">0</span>
                        </a>

                        <!-- Mobile Navigation Toggle -->
                        <i class="mobile-nav-toggle d-xl-none bi bi-list me-0"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="header-nav">
            <div class="container-fluid container-xl position-relative">
                <nav id="navmenu" class="navmenu">
                    <ul>
                        @{
                            var currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
                            var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
                            var isHomeActive = currentAction == "Index" && currentController == "Home";
                            var isProductActive = currentController == "Product";
                            var rootCategories = ViewBag.RootCategories as List<E_Commerce.Dto.CategoryDto> ?? new List<E_Commerce.Dto.CategoryDto>();
                            var allCategories = ViewBag.AllCategories as List<E_Commerce.Dto.CategoryDto> ?? new List<E_Commerce.Dto.CategoryDto>();
                        }
                        <li>@Html.ActionLink("Trang ch·ªß", "Index", "Home", new { area = "User" }, new { @class = isHomeActive ? "active" : "" })</li>
                        <li>@Html.ActionLink("Danh m·ª•c", "Index", "Product", new { area = "User" }, new { @class = isProductActive ? "active" : "" })</li>

                        @* Hi·ªÉn th·ªã danh m·ª•c g·ªëc (level 1) v·ªõi dropdown cho danh m·ª•c con *@
                        @if (rootCategories.Any())
                        {
                            foreach (var category in rootCategories.Take(5))
                            {
                                var categorySubs = allCategories.Where(c => c.ParentCategoryId == category.Id).ToList();

                                if (categorySubs.Any())
                                {
                                    <li class="dropdown">
                                        <a href="@Url.Action("Index", "Product", new { categoryId = category.Id })">
                                            <span>@category.Name</span>
                                            <i class="bi bi-chevron-down toggle-dropdown"></i>
                                        </a>
                                        <ul>
                                            @foreach (var subCat in categorySubs)
                                            {
                                                <li>
                                                    <a href="@Url.Action("Index", "Product", new { categoryId = subCat.Id })">@subCat.Name</a>
                                                </li>
                                            }
                                        </ul>
                                    </li>
                                }
                                else
                                {
                                    <li>
                                        <a href="@Url.Action("Index", "Product", new { categoryId = category.Id })" class="@(ViewBag.CategoryId != null && ViewBag.CategoryId == category.Id ? "active" : "")">
                                            @category.Name
                                        </a>
                                    </li>
                                }
                            }
                        }

                        <li>@Html.ActionLink("Gi·ªõi thi·ªáu", "About", "Home", new { area = "User" }, new { @class = currentAction == "About" && currentController == "Home" ? "active" : "" })</li>
                        <li>@Html.ActionLink("Li√™n h·ªá", "Contact", "Home", new { area = "User" }, new { @class = currentAction == "Contact" && currentController == "Home" ? "active" : "" })</li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Mobile Search Form -->
        <div class="collapse" id="mobileSearch">
            <div class="container">
                <form class="search-form" action="@Url.Action("Index", "Product", new { area = "User" })" method="get">
                    <div class="input-group">
                        <input type="text" name="searchTerm" class="form-control" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." value="@Request.QueryString["searchTerm"]">
                        <button class="btn" type="submit">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <div class="search-suggestions d-none" id="mobileSearchSuggestions"></div>
                </form>
            </div>
        </div>
    </header>

    <main class="main">
        @RenderBody()
    </main>

    <footer id="footer" class="footer dark-background">
        <div class="footer-main">
            <div class="container">
                <div class="row gy-4">
                    <div class="col-lg-4 col-md-6">
                        <div class="footer-widget footer-about">
                            <a href="@Url.Action("Index", "Home", new { area = "User" })" class="logo">
                                <span class="sitename">NovaStore</span>
                            </a>
                            <p>C·ª≠a h√†ng qu·∫ßn √°o th·ªùi trang uy t√≠n, ch·∫•t l∆∞·ª£ng. Ch√∫ng t√¥i cam k·∫øt mang ƒë·∫øn cho kh√°ch h√†ng nh·ªØng s·∫£n ph·∫©m t·ªët nh·∫•t v·ªõi gi√° c·∫£ h·ª£p l√Ω.</p>

                            <div class="social-links mt-4">
                                <h5>K·∫øt n·ªëi v·ªõi ch√∫ng t√¥i</h5>
                                <div class="social-icons">
                                    <a href="#" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
                                    <a href="#" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
                                    <a href="#" aria-label="Twitter"><i class="bi bi-twitter-x"></i></a>
                                    <a href="#" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>
                                    <a href="#" aria-label="Pinterest"><i class="bi bi-pinterest"></i></a>
                                    <a href="#" aria-label="YouTube"><i class="bi bi-youtube"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-2 col-md-6 col-sm-6">
                        <div class="footer-widget">
                            <h4>C·ª≠a h√†ng</h4>
                            <ul class="footer-links">
                                <li><a href="#">S·∫£n ph·∫©m m·ªõi</a></li>
                                @*<li>@Html.ActionLink("S·∫£n ph·∫©m m·ªõi", "Index", "Product", new { area = "" }, null)</li>*@
                                <li><a href="#">B√°n ch·∫°y</a></li>
                                @*<li>@Html.ActionLink("B√°n ch·∫°y", "BestSellers", "Product", new { area = "" }, null)</li>*@
                                <li><a href="#">Qu·∫ßn √°o n·ªØ</a></li>
                                @*<li>@Html.ActionLink("Qu·∫ßn √°o n·ªØ", "Category", "Product", new { area = "", gender = "Female" }, null)</li>*@
                                <li><a href="#">Qu·∫ßn √°o nam</a></li>
                                @*<li>@Html.ActionLink("Qu·∫ßn √°o nam", "Category", "Product", new { area = "", gender = "Male" }, null)</li>*@
                                <li><a href="#">Ph·ª• ki·ªán</a></li>
                                @*<li>@Html.ActionLink("Ph·ª• ki·ªán", "Category", "Product", new { area = "", category = "Accessories" }, null)</li>*@
                                <li><a href="#">Khuy·∫øn m√£i</a></li>
                                @*<li>@Html.ActionLink("Khuy·∫øn m√£i", "Sale", "Product", new { area = "" }, null)</li>*@
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-2 col-md-6 col-sm-6">
                        <div class="footer-widget">
                            <h4>H·ªó tr·ª£</h4>
                            <ul class="footer-links">
                                <li><a href="#">Trung t√¢m tr·ª£ gi√∫p</a></li>
                                @*<li>@Html.ActionLink("Trung t√¢m tr·ª£ gi√∫p", "Support", "Home", new { area = "" }, null)</li>*@
                                <li><a href="#">Tr·∫°ng th√°i ƒë∆°n h√†ng</a></li>
                                @*<li>@Html.ActionLink("Tr·∫°ng th√°i ƒë∆°n h√†ng", "Orders", "Account", new { area = "User" }, null)</li>*@
                                <li><a href="#">Th√¥ng tin v·∫≠n chuy·ªÉn</a></li>
                                @*<li>@Html.ActionLink("Th√¥ng tin v·∫≠n chuy·ªÉn", "Shipping", "Home", new { area = "" }, null)</li>*@
                                <li><a href="#">ƒê·ªïi tr·∫£</a></li>
                                @*<li>@Html.ActionLink("ƒê·ªïi tr·∫£", "Return", "Home", new { area = "" }, null)</li>*@
                                <li><a href="#">H∆∞·ªõng d·∫´n ch·ªçn size</a></li>
                                <li><a href="#">Li√™n h·ªá</a></li>
                                @*<li>@Html.ActionLink("Li√™n h·ªá", "Contact", "Home", new { area = "" }, null)</li>*@
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6">
                        <div class="footer-widget">
                            <h4>Th√¥ng tin li√™n h·ªá</h4>
                            <div class="footer-contact">
                                <div class="contact-item">
                                    <i class="bi bi-geo-alt"></i>
                                    <span>123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ, TP.HCM</span>
                                </div>
                                <div class="contact-item">
                                    <i class="bi bi-telephone"></i>
                                    <span>+84 (123) 456-789</span>
                                </div>
                                <div class="contact-item">
                                    <i class="bi bi-envelope"></i>
                                    <span>info@novashop.com</span>
                                </div>
                                <div class="contact-item">
                                    <i class="bi bi-clock"></i>
                                    <span>Th·ª© 2 - Th·ª© 6: 9:00 - 18:00<br>Th·ª© 7: 10:00 - 16:00<br>Ch·ªß nh·∫≠t: Ngh·ªâ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="container">
                <div class="row gy-3 align-items-center">
                    <div class="col-lg-6 col-md-12">
                        <div class="copyright">
                            <p>¬© <span>Copyright</span> <strong class="sitename">NovaStore</strong>. All Rights Reserved.</p>
                        </div>
                        <div class="credits mt-1">
                            Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
                        </div>
                    </div>

                    <div class="col-lg-6 col-md-12">
                        <div class="d-flex flex-wrap justify-content-lg-end justify-content-center align-items-center gap-4">
                            <div class="payment-methods">
                                <div class="payment-icons">
                                    <i class="bi bi-credit-card" aria-label="Credit Card"></i>
                                    <i class="bi bi-paypal" aria-label="PayPal"></i>
                                    <i class="bi bi-apple" aria-label="Apple Pay"></i>
                                    <i class="bi bi-google" aria-label="Google Pay"></i>
                                    <i class="bi bi-shop" aria-label="Shop Pay"></i>
                                    <i class="bi bi-cash" aria-label="Cash on Delivery"></i>
                                </div>
                            </div>

                            <div class="legal-links">
                                <a href="#">ƒêi·ªÅu kho·∫£n</a>
                                @*<a href="@Url.Action("Terms", "Home", new { area = "" })">ƒêi·ªÅu kho·∫£n</a>*@
                                <a href="#">B·∫£o m·∫≠t</a>
                                @*<a href="@Url.Action("Privacy", "Home", new { area = "" })">B·∫£o m·∫≠t</a>*@
                                <a href="#">Cookies</a>
                                @*<a href="@Url.Action("Cookies", "Home", new { area = "" })">Cookies</a>*@
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll Top -->
    <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

    <!-- Preloader -->
    <div id="preloader"></div>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css" rel="stylesheet" />
    <!-- JavaScript Bundles - jQuery ph·∫£i load tr∆∞·ªõc toastr -->
    @Scripts.Render("~/bundles/jquery")
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.12/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
    <script>
        // Configure Toastr globally
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                closeButton: true,
                progressBar: true,
                timeOut: 3000,
                positionClass: "toast-top-right",
                showMethod: "fadeIn",
                hideMethod: "fadeOut",
                preventDuplicates: false
            };
        }
        
        // Di chuy·ªÉn toast-container v√†o main content ƒë·ªÉ scroll c√πng trang
        $(document).ready(function() {
            // ƒê·ª£i toastr t·∫°o toast-container
            setTimeout(function() {
                var toastContainer = $('#toast-container');
                var mainContent = $('main.main');
                
                if (toastContainer.length && mainContent.length) {
                    // Di chuy·ªÉn toast-container v√†o trong main
                    toastContainer.appendTo(mainContent);
                    // ƒê·∫£m b·∫£o main c√≥ position relative
                    if (mainContent.css('position') === 'static') {
                        mainContent.css('position', 'relative');
                    }
                }
            }, 100);
            
            // Load cart + wishlist count on page load
            refreshCartCount();
            refreshWishlistCount();
        });
        
        // Function to refresh cart count in header
        function refreshCartCount() {
            $.ajax({
                url: '@Url.Action("GetCartCount", "Cart", new { area = "User" })',
                type: 'GET',
                success: function(response) {
                    if (response && typeof response.count !== 'undefined') {
                        $('#cart-count').text(response.count).show();
                    }
                },
                error: function() {
                    // Silently fail - don't show error for cart count
                }
            });
        }
        
        // Function to refresh wishlist count in header
        function refreshWishlistCount() {
            $.ajax({
                url: '@Url.Action("GetCount", "Wishlist", new { area = "User" })',
                type: 'GET',
                success: function(response) {
                    if (response && typeof response.count !== 'undefined') {
                        var count = response.count || 0;
                        $('#wishlist-count').text(count).show();
                        $('#wishlist-count-dropdown').text(count);
                        if (count > 0) {
                            $('#wishlist-count-dropdown').show();
                        } else {
                            $('#wishlist-count-dropdown').hide();
                        }
                    }
                },
                error: function() {
                    // Silently fail
                }
            });
        }
        
        // Make function globally available
        window.refreshCartCount = refreshCartCount;
        window.refreshWishlistCount = refreshWishlistCount;

        // Wishlist add (global)
        (function () {
            function getToken() {
                var $tokenInput = $('#global-antiforgery input[name="__RequestVerificationToken"]');
                return $tokenInput.length > 0 ? $tokenInput.val() : '';
            }

            function markWishlisted($btn) {
                $btn.addClass('active');
                var $icon = $btn.find('i');
                $icon.removeClass('bi-heart').addClass('bi-heart-fill text-danger');
            }

            function unmarkWishlisted($btn) {
                $btn.removeClass('active');
                var $icon = $btn.find('i');
                $icon.removeClass('bi-heart-fill text-danger').addClass('bi-heart');
            }

            $(document).on('click', '.wishlist-btn', function (e) {
                e.preventDefault();
                var $btn = $(this);
                var productId = $btn.data('product-id');
                if (!productId) {
                    console.warn('Wishlist: productId not found');
                    return;
                }

                // L·∫•y token m·ªói l·∫ßn click ƒë·ªÉ ƒë·∫£m b·∫£o token lu√¥n m·ªõi
                var token = getToken();
                if (!token) {
                    console.error('Wishlist: AntiForgeryToken not found');
                    if (typeof toastr !== 'undefined') {
                        toastr.error('L·ªói b·∫£o m·∫≠t. Vui l√≤ng t·∫£i l·∫°i trang.');
                    }
                    return;
                }

                // Check xem ƒë√£ c√≥ trong wishlist ch∆∞a
                var isInWishlist = $btn.hasClass('active');

                // Disable button ƒë·ªÉ tr√°nh double click
                $btn.prop('disabled', true);

                var url = isInWishlist 
                    ? '@Url.Action("Remove", "Wishlist", new { area = "User" })'
                    : '@Url.Action("Add", "Wishlist", new { area = "User" })';

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {
                        productId: productId,
                        __RequestVerificationToken: token
                    },
                    success: function (response) {
                        if (response && response.success) {
                            if (isInWishlist) {
                                unmarkWishlisted($btn);
                                if (typeof toastr !== 'undefined') {
                                    toastr.success(response.message || 'ƒê√£ x√≥a kh·ªèi y√™u th√≠ch.');
                                }
                            } else {
                                markWishlisted($btn);
                                if (typeof toastr !== 'undefined') {
                                    toastr.success(response.message || 'ƒê√£ th√™m v√†o y√™u th√≠ch.');
                                }
                            }
                            
                            if (response.count !== undefined) {
                                var count = response.count || 0;
                                $('#wishlist-count').text(count).show();
                                $('#wishlist-count-dropdown').text(count);
                                if (count > 0) {
                                    $('#wishlist-count-dropdown').show();
                                } else {
                                    $('#wishlist-count-dropdown').hide();
                                }
                            } else if (window.refreshWishlistCount) {
                                window.refreshWishlistCount();
                            }
                        } else if (response && response.message) {
                            if (typeof toastr !== 'undefined') {
                                toastr.warning(response.message);
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Wishlist Error:', {
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseText: xhr.responseText,
                            error: error
                        });
                        
                        var errorMessage = 'Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c. Vui l√≤ng th·ª≠ l·∫°i.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.status === 500) {
                            errorMessage = 'L·ªói server. Vui l√≤ng th·ª≠ l·∫°i sau.';
                        } else if (xhr.status === 401 || xhr.status === 403) {
                            errorMessage = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.';
                        }
                        
                        if (typeof toastr !== 'undefined') {
                            toastr.error(errorMessage);
                        }
                    },
                    complete: function () {
                        // Re-enable button
                        $btn.prop('disabled', false);
                    }
                });
            });
        })();

        // Search suggest (desktop & mobile)
        (function () {
            var $desktopInput = $('.desktop-search-form input[name="searchTerm"]');
            var $desktopBox = $('#searchSuggestions');
            var $mobileInput = $('#mobileSearch input[name="searchTerm"]');
            var $mobileBox = $('#mobileSearchSuggestions');
            var suggestUrl = '@Url.Action("Suggest", "Product", new { area = "User" })';
            var debounceTimer;

            function renderSuggestions($box, items) {
                if (!items || !items.length) {
                    $box.addClass('d-none').empty();
                    return;
                }
                var html = '<ul class="list-unstyled mb-0">';
                items.forEach(function (p) {
                    html += '<li class="suggest-item">' +
                        '<a href="' + p.url + '">' +
                        '<div class="suggest-thumb"><img src="' + p.image + '" onerror="this.src=\'/Content/images/default-product.png\'" /></div>' +
                        '<div class="suggest-info">' +
                        '<div class="suggest-name">' + p.name + '</div>' +
                        '<div class="suggest-price">' + (p.price ? p.price.toLocaleString("vi-VN") + " ƒë" : "") + '</div>' +
                        '</div>' +
                        '</a>' +
                        '</li>';
                });
                html += '</ul>';
                $box.html(html).removeClass('d-none');
            }

            function wireInput($input, $box) {
                $input.on('keyup', function (e) {
                    var val = $(this).val() || '';
                    if (e.key === 'Escape') {
                        $box.addClass('d-none');
                        return;
                    }
                    clearTimeout(debounceTimer);
                    if (val.trim().length < 2) {
                        $box.addClass('d-none').empty();
                        return;
                    }
                    debounceTimer = setTimeout(function () {
                        $.get(suggestUrl, { term: val }, function (res) {
                            if (res && res.success) {
                                renderSuggestions($box, res.items);
                            } else {
                                $box.addClass('d-none').empty();
                            }
                        });
                    }, 200);
                });

                $(document).on('click', function (e) {
                    if (!$(e.target).closest('.search-form').length) {
                        $box.addClass('d-none');
                    }
                });
            }

            wireInput($desktopInput, $desktopBox);
            wireInput($mobileInput, $mobileBox);
        })();
    </script>
    <form id="global-antiforgery" class="d-none">
        @Html.AntiForgeryToken()
    </form>
    @Scripts.Render("~/bundles/vendor") <!-- Bootstrap bundle (ƒë√£ bao g·ªìm Popper) -->
    @Scripts.Render("~/bundles/main")

    @RenderSection("scripts", required: false)
</body>
</html>